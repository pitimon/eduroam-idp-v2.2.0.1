# ระบบความปลอดภัยและการป้องกัน Brute Force

## ภาพรวมระบบความปลอดภัย

eduroam API Web Service มีระบบความปลอดภัยหลายชั้นที่ป้องกันการโจมตีแบบ brute force และการใช้รหัสยืนยันที่หมดอายุ

### การป้องกัน Brute Force

1. **Rate Limiting**
   - จำกัดจำนวนครั้งที่สามารถพยายามล็อกอินผิดพลาดได้ (ค่าเริ่มต้น: 5 ครั้ง)
   - หากเกินขีดจำกัด จะถูกล็อคเป็นเวลา 30 นาที
   - การวัดจำนวนครั้งทำโดยใช้ Redis เพื่อความเร็วและความแม่นยำ

2. **รหัสยืนยัน 8 หลัก**
   - รหัสยืนยัน 8 หลักสร้างความยากในการเดารหัส (โอกาส 1 ใน 100,000,000)
   - มีการสร้างรหัสด้วยฟังก์ชัน Cryptographic secure random

3. **จำกัดการพยายามใช้รหัสเดียวกัน**
   - อนุญาตให้ใช้รหัสยืนยันได้เพียง 5 ครั้ง
   - หากเกินจำนวนครั้ง จะต้องขอรหัสใหม่

### การจัดการรหัสที่หมดอายุ

1. **อายุรหัสยืนยัน**
   - รหัสยืนยันมีอายุ 15 นาที
   - เมื่อหมดอายุ จะไม่สามารถใช้รหัสนั้นได้อีก

2. **การยกเลิกรหัสเมื่อมีการสร้างรหัสใหม่**
   - เมื่อมีการสร้างรหัสใหม่ รหัสเก่าจะถูกยกเลิกโดยอัตโนมัติ
   - ป้องกันการใช้รหัสเก่าที่อาจรั่วไหล

3. **การยกเลิกรหัสเมื่อยืนยันสำเร็จ**
   - รหัสจะถูกยกเลิกทันทีหลังจากใช้ยืนยันสำเร็จ
   - ป้องกันการใช้รหัสซ้ำ

### การจัดการ Token

1. **Token Blacklist**
   - Token ที่ถูก logout จะถูกเพิ่มลงใน blacklist ใน Redis
   - Token ที่อยู่ใน blacklist จะไม่สามารถใช้งานได้แม้ยังไม่หมดอายุ

2. **การตรวจสอบ Token ทุกครั้งที่เรียกใช้ API**
   - ตรวจสอบความถูกต้องของ Token
   - ตรวจสอบว่า Token อยู่ใน blacklist หรือไม่
   - ตรวจสอบสิทธิ์การเข้าถึงตามโดเมนที่ได้รับอนุญาต

3. **การล้างข้อมูล Token ที่หมดอายุ**
   - มีการล้าง Token ที่หมดอายุอัตโนมัติทุกวัน
   - ป้องกันการสะสมข้อมูลที่ไม่จำเป็น

## การตั้งค่าและการปรับแต่ง

ค่าต่างๆ สามารถปรับแต่งได้ผ่านตัวแปรสภาพแวดล้อม (.env):
```
Rate Limiting
RATE_LIMIT_MAX_ATTEMPTS=5   # จำนวนครั้งสูงสุดที่สามารถพยายามได้
RATE_LIMIT_WINDOW=3600      # ช่วงเวลาที่วัดจำนวนครั้งที่พยายาม (วินาที)
LOCKOUT_DURATION=1800       # ระยะเวลาที่ถูกล็อค (วินาที)
```

## การแก้ไขปัญหา

กรณีผู้ใช้ถูกล็อคเนื่องจากพยายามเข้าสู่ระบบมากเกินไป:

1. **ล้างการล็อคด้วย Redis CLI**:
```
redis-cli DEL "auth:attempts:email:user@example.com"
```
2. **ล้าง Token จาก Blacklist**:
```
redis-cli DEL "auth:blacklist:eyJhbGciOiJIUzI1..."
```

## การตรวจสอบความปลอดภัย

1. **ตรวจสอบความพยายามเข้าสู่ระบบ**:
```bash
# ดูจำนวนครั้งที่พยายามเข้าสู่ระบบของผู้ใช้
redis-cli HGETALL "auth:attempts:email:user@example.com"
```
2. **ตรวจสอบ Token ที่ถูก Blacklist**:

```bash
# ดูรายการ Token ที่ถูก Blacklist
redis-cli KEYS "auth:blacklist:*"
```

---